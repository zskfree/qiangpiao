<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±å¤§ç¾½çƒé¢„çº¦ - Cookieç®¡ç†</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }

        .nav-links a:hover {
            color: #764ba2;
        }

        .status-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-valid {
            background-color: #28a745;
        }

        .status-invalid {
            background-color: #dc3545;
        }

        .status-unknown {
            background-color: #6c757d;
        }

        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs-nav {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
            border-right: 1px solid #e9ecef;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            background: white;
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 20px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .method-card {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .method-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .input-group {
            display: flex;
            width: 100%;
            align-items: center; /* ä¿æŒï¼šç”¨äºå‚ç›´å¯¹é½ */
        }

        .input-group .form-control {
            border-radius: 8px 0 0 8px;
            flex: 1;
            /* ç»§æ‰¿ .form-control çš„ padding, font-size, border ç­‰æ ·å¼ */
            /* è®¾ç½®æ˜¾å¼é«˜åº¦ä»¥ç¡®ä¿å¯¹é½ */
            height: 40px; /* æ‚¨å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´æ­¤å€¼ */
            /* .form-control å·²æœ‰ box-sizing: border-box; */
            margin: 0; /* ç¡®ä¿è¾“å…¥æ¡†ä¹Ÿæ²¡æœ‰æ„å¤–çš„è¾¹è· */
            /* æ–°å¢ï¼šè®¾ç½®è¡Œé«˜ä»¥æ”¹å–„æ–‡æœ¬å‚ç›´å±…ä¸­æ„Ÿ */
            line-height: 16px; /* è®¡ç®—å€¼: 40px - (2*10px padding) - (2*2px border) */
        }

        .input-group .btn {
            border-radius: 0 8px 8px 0;
            flex-shrink: 0;
            padding: 10px 15px; 
            font-size: 12px; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            /* è®¾ç½®æ˜¾å¼é«˜åº¦å¹¶ç¡®ä¿ box-sizing */
            height: 40px; /* ä¸è¾“å…¥æ¡†é«˜åº¦ä¸€è‡´ */
            box-sizing: border-box; /* ç¡®ä¿ height åŒ…å« padding å’Œ border */
            margin: 0; /* æ–°å¢ï¼šç§»é™¤æˆ–é‡ç½®æŒ‰é’®çš„å¤–è¾¹è· */
            /* æ–°å¢ï¼šè®¾ç½®è¡Œé«˜ä»¥æ”¹å–„æ–‡æœ¬å‚ç›´å±…ä¸­æ„Ÿ */
            line-height: 16px; /* è®¡ç®—å€¼: 40px - (2*10px padding) - (2*2px border) */
        }

        .cookie-textarea {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #bd2130);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .step-number {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-right: 8px;
            font-weight: bold;
        }

        .browser-warning {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .status-item strong {
            color: #667eea;
        }

        .password-saved-hint {
            color: #28a745 !important;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        .form-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .tabs-nav {
                flex-direction: column;
            }

            .tab-button {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .tab-button:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª Cookieç®¡ç†</h1>
            <p>ç®¡ç†ç™»å½•å‡­è¯ï¼Œç¡®ä¿ç³»ç»Ÿæ­£å¸¸è®¿é—®</p>
        </div>

        <div class="nav-links">
            <a href="/">ğŸ  é¦–é¡µ</a>
            <a href="/config">ğŸ”§ é…ç½®ç®¡ç†</a>
            <a href="/booking">ğŸ¯ æŠ¢ç¥¨</a>
        </div>

        <!-- CookieçŠ¶æ€å¡ç‰‡ -->
        <div class="status-card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div>
                    <h3 style="margin: 0; color: #667eea;">ğŸ” CookieçŠ¶æ€</h3>
                    <p style="margin: 5px 0 0 0; color: #666;">å½“å‰ç™»å½•å‡­è¯éªŒè¯ä¿¡æ¯</p>
                </div>
                <div>
                    <button class="btn btn-outline" onclick="refreshCookieStatus()">
                        ğŸ”„ åˆ·æ–°çŠ¶æ€
                    </button>
                </div>
            </div>

            <div id="cookieStatus" style="margin-top: 20px; text-align: center; padding: 20px;">
                <div class="spinner"></div>
                <span>æ­£åœ¨æ£€æŸ¥CookieçŠ¶æ€...</span>
            </div>
        </div>

        <!-- Cookieç®¡ç†é€‰é¡¹å¡ -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="switchTab('autoGet')">ğŸ¤– è‡ªåŠ¨è·å–</button>
                <button class="tab-button" onclick="switchTab('manualUpdate')">âœï¸ æ‰‹åŠ¨æ›´æ–°</button>
                <button class="tab-button" onclick="switchTab('instructions')">ğŸ“– ä½¿ç”¨è¯´æ˜</button>
            </div>

            <div class="tab-content">
                <!-- è‡ªåŠ¨è·å– -->
                <div class="tab-pane active" id="autoGet">
                    <div class="method-card">
                        <div class="method-title">ğŸ¤– è‡ªåŠ¨è·å–Cookie</div>
                        <p style="color: #666; margin-bottom: 20px;">
                            è¾“å…¥æ ¡å›­ç½‘è´¦å·å¯†ç ï¼Œç³»ç»Ÿå°†å¯åŠ¨æµè§ˆå™¨è‡ªåŠ¨ç™»å½•ã€‚<strong>å¦‚éœ€éªŒè¯ç ï¼Œè¯·åœ¨å¼¹å‡ºçš„æµè§ˆå™¨çª—å£ä¸­å®Œæˆã€‚</strong></p>

                        <div class="alert alert-info">
                            <strong>é‡è¦è¯´æ˜ï¼š</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li>ç‚¹å‡»è·å–åä¼šå¼¹å‡ºæµè§ˆå™¨çª—å£</li>
                                <li>å¦‚æœéœ€è¦ä¼ä¸šå¾®ä¿¡éªŒè¯ç ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­è¾“å…¥</li>
                                <li>å®Œæˆç™»å½•åCookieä¼šè‡ªåŠ¨è·å–</li>
                                <li>æ•´ä¸ªè¿‡ç¨‹å¤§çº¦éœ€è¦30-180ç§’</li>
                                <li><strong>è¯·ä¸è¦å…³é—­å¼¹å‡ºçš„æµè§ˆå™¨çª—å£</strong></li>
                            </ul>
                        </div>

                        <form id="autoGetForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>å­¦å·/å·¥å·:</label>
                                    <input type="text" class="form-control" id="autoUsername" placeholder="è¯·è¾“å…¥å­¦å·æˆ–å·¥å·">
                                </div>
                                <div class="form-group">
                                    <label>å¯†ç :</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="autoPassword"
                                            placeholder="è¯·è¾“å…¥ç»Ÿä¸€èº«ä»½è®¤è¯å¯†ç ">
                                        <button type="button" class="btn btn-outline" onclick="clearSavedPassword()"
                                            title="æ¸…é™¤å·²ä¿å­˜çš„å¯†ç ">
                                            ğŸ—‘ï¸ æ¸…é™¤
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn" id="autoGetButton" onclick="autoGetCookie()">
                                    ğŸš€ è‡ªåŠ¨è·å–Cookie
                                </button>
                                <button type="button" class="btn btn-outline" onclick="loadAccountConfig()">
                                    ğŸ”„ é‡æ–°åŠ è½½è´¦å·
                                </button>
                            </div>
                        </form>

                        <div id="autoGetResult" style="display: none;">
                            <div class="alert" id="autoGetAlert">
                                <div id="autoGetMessage"></div>
                                <div id="autoGetProgress" style="display: none; margin-top: 10px;">
                                    <div style="background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                                        <div
                                            style="background: linear-gradient(45deg, #667eea, #764ba2); height: 8px; width: 100%; animation: progress 2s ease-in-out infinite;">
                                        </div>
                                    </div>
                                </div>
                                <div id="autoGetStatusLog" style="display: none; margin-top: 10px;">
                                    <small style="color: #666;">
                                        <strong>è¯¦ç»†çŠ¶æ€ï¼š</strong>
                                        <div id="statusLogContent" style="margin-top: 5px;"></div>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‰‹åŠ¨æ›´æ–° -->
                <div class="tab-pane" id="manualUpdate">
                    <div class="method-card">
                        <div class="method-title">âœï¸ æ‰‹åŠ¨æ›´æ–°Cookie</div>
                        <p style="color: #666; margin-bottom: 20px;">å¦‚æœè‡ªåŠ¨è·å–å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨å¤åˆ¶æµè§ˆå™¨ä¸­çš„Cookieã€‚</p>

                        <form id="manualUpdateForm">
                            <div class="form-group">
                                <label>Cookieå†…å®¹:</label>
                                <textarea class="form-control cookie-textarea" id="cookieText" rows="6"
                                    placeholder="è¯·åœ¨æ­¤ç²˜è´´ä»æµè§ˆå™¨å¤åˆ¶çš„Cookie..."></textarea>
                                <div class="form-text">
                                    æ”¯æŒå¤šç§æ ¼å¼ï¼šæµè§ˆå™¨å¼€å‘è€…å·¥å…·æ ¼å¼ã€å¤šè¡Œæ ¼å¼ç­‰
                                </div>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn" onclick="testCookie()">
                                    âœ… æµ‹è¯•Cookie
                                </button>
                                <button type="button" class="btn btn-success" onclick="updateCookie()">
                                    ğŸ’¾ æ›´æ–°Cookie
                                </button>
                                <button type="button" class="btn btn-outline" onclick="clearCookieText()">
                                    ğŸ—‘ï¸ æ¸…ç©º
                                </button>
                            </div>
                        </form>

                        <div id="manualResult" style="display: none;">
                            <div class="alert" id="manualAlert">
                                <div id="manualMessage"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="tab-pane" id="instructions">
                    <div class="method-card">
                        <div class="method-title">ğŸ“– Cookieè·å–è¯´æ˜</div>

                        <h4 style="margin-top: 20px; color: #667eea;">ğŸ¤– è‡ªåŠ¨è·å–æ–¹å¼ï¼ˆæ¨èï¼‰</h4>
                        <div style="padding-left: 15px;">
                            <p><span class="step-number">1</span>è¾“å…¥æ‚¨çš„å­¦å·å’Œç»Ÿä¸€èº«ä»½è®¤è¯å¯†ç </p>
                            <p><span class="step-number">2</span>ç‚¹å‡»"è‡ªåŠ¨è·å–Cookie"æŒ‰é’®</p>
                            <p><span class="step-number">3</span>ç­‰å¾…æµè§ˆå™¨çª—å£å¼¹å‡º</p>
                            <p><span class="step-number">4</span>å¦‚æœéœ€è¦ä¼ä¸šå¾®ä¿¡éªŒè¯ç ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥</p>
                            <p><span class="step-number">5</span>ç³»ç»Ÿå°†è‡ªåŠ¨å®Œæˆç™»å½•å¹¶è·å–Cookie</p>
                        </div>

                        <div class="alert alert-warning">
                            <strong>æ³¨æ„ï¼š</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li>è·å–è¿‡ç¨‹ä¸­ä¼šå¼¹å‡ºæµè§ˆå™¨çª—å£ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡</li>
                                <li>å¦‚æœé‡åˆ°ä¼ä¸šå¾®ä¿¡éªŒè¯ç ï¼Œè¯·åŠæ—¶åœ¨æµè§ˆå™¨ä¸­è¾“å…¥</li>
                                <li>è¯·ä¸è¦å…³é—­æµè§ˆå™¨çª—å£ï¼Œç­‰å¾…è‡ªåŠ¨å®Œæˆ</li>
                                <li>å¦‚æœé•¿æ—¶é—´æ— å“åº”ï¼Œå¯ä»¥å°è¯•æ‰‹åŠ¨è·å–æ–¹å¼</li>
                            </ul>
                        </div>

                        <h4 style="margin-top: 20px; color: #667eea;">âœï¸ æ‰‹åŠ¨è·å–æ–¹å¼</h4>
                        <div style="padding-left: 15px;">
                            <p><span class="step-number">1</span>ä½¿ç”¨æµè§ˆå™¨è®¿é—® <code>https://ehall.szu.edu.cn</code> å¹¶ç™»å½•</p>
                            <p><span class="step-number">2</span>è¿›å…¥ä½“è‚²åœºé¦†é¢„çº¦é¡µé¢</p>
                            <p><span class="step-number">3</span>æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ°Networké€‰é¡¹å¡</p>
                            <p><span class="step-number">4</span>åˆ·æ–°é¡µé¢ï¼Œæ‰¾åˆ°ä»»æ„è¯·æ±‚ï¼Œå¤åˆ¶å…¶Cookieå€¼</p>
                            <p><span class="step-number">5</span>å°†Cookieç²˜è´´åˆ°æ‰‹åŠ¨æ›´æ–°ç•Œé¢å¹¶ç‚¹å‡»æ›´æ–°</p>
                        </div>

                        <div class="alert alert-warning">
                            <strong>é‡è¦æé†’ï¼š</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li>CookieåŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·å‹¿æ³„éœ²ç»™ä»–äºº</li>
                                <li>Cookieæœ‰æ—¶æ•ˆæ€§ï¼Œè¿‡æœŸåéœ€è¦é‡æ–°è·å–</li>
                                <li>å»ºè®®å®šæœŸæ›´æ–°Cookieä»¥ç¡®ä¿ç¨‹åºæ­£å¸¸è¿è¡Œ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');

            // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
            event.target.classList.add('active');
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥CookieçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function () {
            refreshCookieStatus();
            loadAccountConfig();
        });

        // åˆ·æ–°CookieçŠ¶æ€
        function refreshCookieStatus() {
            const statusDiv = document.getElementById('cookieStatus');
            statusDiv.innerHTML = `
                <div class="spinner"></div>
                <span>æ­£åœ¨æ£€æŸ¥CookieçŠ¶æ€...</span>
            `;

            fetch('/api/cookie/current')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const statusClass = data.valid ? 'status-valid' : 'status-invalid';
                        const statusText = data.valid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ';
                        const statusIcon = data.valid ? 'âœ…' : 'âŒ';

                        statusDiv.innerHTML = `
                            <div class="status-grid">
                                <div class="status-item">
                                    <strong>CookieçŠ¶æ€</strong><br>
                                    <span class="status-indicator ${statusClass}"></span>${statusIcon} ${statusText}<br>
                                    <small style="color: #666;">Cookieå­—æ®µæ•°é‡: ${data.cookie_count}</small>
                                </div>
                                <div class="status-item">
                                    <strong>éªŒè¯ä¿¡æ¯</strong><br>
                                    <span style="color: #666;">${data.message}</span><br>
                                    ${data.last_update ? `<small style="color: #666;">æœ€åæ›´æ–°: ${data.last_update}</small>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div style="text-align: center;">
                                <span class="status-indicator status-invalid"></span>
                                <strong>è·å–çŠ¶æ€å¤±è´¥</strong>
                                <p style="color: #dc3545; margin-top: 10px;">${data.message}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('æ£€æŸ¥CookieçŠ¶æ€é”™è¯¯:', error);
                    statusDiv.innerHTML = `
                        <div style="text-align: center; color: #dc3545;">
                            âš ï¸ æ£€æŸ¥çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}
                            <br><button class="btn btn-outline" onclick="refreshCookieStatus()" style="margin-top: 10px;">é‡è¯•</button>
                        </div>
                    `;
                });
        }

        // åŠ è½½è´¦æˆ·é…ç½®
        function loadAccountConfig() {
            fetch('/api/config/campus_account')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.account) {
                        const usernameField = document.getElementById('autoUsername');
                        const passwordField = document.getElementById('autoPassword');

                        // å¡«å……ç”¨æˆ·å
                        if (data.account.username) {
                            usernameField.value = data.account.username;
                        }

                        // å¦‚æœå¯†ç å·²ä¿å­˜ï¼Œè®¾ç½®ä¸€ä¸ªæ ‡è®°
                        if (data.account.password && data.account.password !== '') {
                            passwordField.placeholder = 'å¯†ç å·²ä¿å­˜ï¼Œå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥';
                            passwordField.setAttribute('data-has-saved-password', 'true');
                            // æ˜¾ç¤ºå¯†ç å·²ä¿å­˜çš„æç¤º
                            showPasswordSavedHint();
                        } else {
                            passwordField.placeholder = 'è¯·è¾“å…¥ç»Ÿä¸€èº«ä»½è®¤è¯å¯†ç ';
                            passwordField.removeAttribute('data-has-saved-password');
                        }
                    }
                })
                .catch(error => console.error('åŠ è½½è´¦æˆ·é…ç½®å¤±è´¥:', error));
        }

        // æ˜¾ç¤ºå¯†ç å·²ä¿å­˜çš„æç¤º
        function showPasswordSavedHint() {
            const passwordField = document.getElementById('autoPassword');
            const parentDiv = passwordField.parentElement;

            // ç§»é™¤å·²å­˜åœ¨çš„æç¤º
            const existingHint = parentDiv.querySelector('.password-saved-hint');
            if (existingHint) {
                existingHint.remove();
            }

            // æ·»åŠ æ–°çš„æç¤º
            const hint = document.createElement('small');
            hint.className = 'text-success password-saved-hint mt-1';
            hint.innerHTML = `
                <i class="bi bi-check-circle"></i> 
                <span>å¯†ç å·²ä¿å­˜</span><br>
                <span>å¯ç›´æ¥è·å–Cookie</span>
                `;
            parentDiv.appendChild(hint);
        }

        // è‡ªåŠ¨è·å–Cookie
        function autoGetCookie() {
            const username = document.getElementById('autoUsername').value.trim();
            const passwordField = document.getElementById('autoPassword');
            let password = passwordField.value.trim();

            // æ£€æŸ¥ç”¨æˆ·å
            if (!username) {
                showAutoGetResult('è¯·è¾“å…¥ç”¨æˆ·å', 'danger');
                return;
            }

            // æ£€æŸ¥å¯†ç ï¼šå¦‚æœæœ‰ä¿å­˜çš„å¯†ç ä¸”å½“å‰è¾“å…¥ä¸ºç©ºï¼Œä½¿ç”¨ä¿å­˜çš„å¯†ç 
            const hasSavedPassword = passwordField.getAttribute('data-has-saved-password') === 'true';

            if (!password && !hasSavedPassword) {
                showAutoGetResult('è¯·è¾“å…¥å¯†ç ', 'danger');
                return;
            }

            // å¦‚æœæ²¡æœ‰è¾“å…¥æ–°å¯†ç ä½†æœ‰ä¿å­˜çš„å¯†ç ï¼Œä½¿ç”¨ä¿å­˜çš„å¯†ç æ ‡è®°
            if (!password && hasSavedPassword) {
                password = '***'; // ç‰¹æ®Šæ ‡è®°ï¼Œè¡¨ç¤ºä½¿ç”¨å·²ä¿å­˜çš„å¯†ç 
            }

            const resultDiv = document.getElementById('autoGetResult');
            const messageDiv = document.getElementById('autoGetMessage');
            const progressDiv = document.getElementById('autoGetProgress');
            const statusLogDiv = document.getElementById('autoGetStatusLog');
            const statusLogContent = document.getElementById('statusLogContent');
            const button = document.getElementById('autoGetButton');

            // æ˜¾ç¤ºè¿›åº¦
            messageDiv.innerHTML = `
                <div class="browser-warning">
                    <i class="bi bi-hourglass-split"></i> 
                    <strong>æ­£åœ¨å¯åŠ¨æµè§ˆå™¨è·å–Cookie...</strong>
                    <br><small class="text-muted">
                        ğŸŒ ä½¿ç”¨å·²ä¿å­˜çš„è´¦å·ä¿¡æ¯ï¼Œè¯·æ³¨æ„æµè§ˆå™¨çª—å£å¼¹å‡ºã€‚
                        <br>å¦‚éœ€ä¼ä¸šå¾®ä¿¡éªŒè¯ç è¯·åŠæ—¶è¾“å…¥ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦30-180ç§’ã€‚
                        <br><strong>âš ï¸ è¯·ä¸è¦å…³é—­å¼¹å‡ºçš„æµè§ˆå™¨çª—å£ï¼</strong>
                    </small>
                </div>
            `;
            resultDiv.className = 'mt-3 alert alert-info';
            resultDiv.style.display = 'block';
            progressDiv.style.display = 'block';
            statusLogDiv.style.display = 'none';

            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> è·å–ä¸­...';

            // è®¾ç½®è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 240000); // 4åˆ†é’Ÿè¶…æ—¶

            fetch('/api/cookie/auto_get', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password }),
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    progressDiv.style.display = 'none';

                    // æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€æ—¥å¿—
                    if (data.status_log && data.status_log.length > 0) {
                        statusLogContent.innerHTML = data.status_log.map(msg => `<div>â€¢ ${msg}</div>`).join('');
                        statusLogDiv.style.display = 'block';
                    }

                    if (data.success) {
                        messageDiv.innerHTML = `
                        <i class="bi bi-check-circle"></i> 
                        <strong>è·å–æˆåŠŸï¼</strong> Cookieå·²è‡ªåŠ¨æ›´æ–°
                        <br><small class="text-muted">Cookieé•¿åº¦: ${data.cookie.length} å­—ç¬¦</small>
                    `;
                        resultDiv.className = 'mt-3 alert alert-success';

                        // åˆ·æ–°çŠ¶æ€å¹¶ä¿å­˜è´¦æˆ·ä¿¡æ¯
                        setTimeout(() => refreshCookieStatus(), 1000);

                        // å¦‚æœä½¿ç”¨äº†æ–°å¯†ç ï¼Œä¿å­˜è´¦æˆ·ä¿¡æ¯
                        if (password !== '***') {
                            saveAccountConfig(username, password);
                        }

                        // æ›´æ–°ç•Œé¢çŠ¶æ€
                        if (password !== '***') {
                            passwordField.setAttribute('data-has-saved-password', 'true');
                            passwordField.placeholder = 'å¯†ç å·²ä¿å­˜ï¼Œå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥';
                            passwordField.value = ''; // æ¸…ç©ºæ˜¾ç¤ºçš„å¯†ç 
                            showPasswordSavedHint();
                        }
                    } else {
                        messageDiv.innerHTML = `
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>è·å–å¤±è´¥ï¼š</strong>${data.message}
                        <br><small class="text-muted">
                            å¦‚æœé‡åˆ°ä¼ä¸šå¾®ä¿¡éªŒè¯ç é—®é¢˜ï¼Œè¯·å°è¯•æ‰‹åŠ¨è·å–æ–¹å¼
                        </small>
                    `;
                        resultDiv.className = 'mt-3 alert alert-danger';
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    progressDiv.style.display = 'none';

                    let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                    if (error.name === 'AbortError') {
                        errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œå¯èƒ½æ˜¯éªŒè¯ç è¾“å…¥æ—¶é—´è¿‡é•¿';
                    } else if (error.message.includes('HTTP')) {
                        errorMessage = `æœåŠ¡å™¨é”™è¯¯: ${error.message}`;
                    }

                    messageDiv.innerHTML = `
                    <i class="bi bi-x-circle"></i> 
                    <strong>é”™è¯¯ï¼š</strong>${errorMessage}
                    <br><small class="text-muted">è¯·å°è¯•é‡æ–°è·å–æˆ–ä½¿ç”¨æ‰‹åŠ¨æ–¹å¼</small>
                `;
                    resultDiv.className = 'mt-3 alert alert-danger';
                    console.error('è‡ªåŠ¨è·å–Cookieå¤±è´¥:', error);
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-download"></i> è‡ªåŠ¨è·å–Cookie';
                });
        }

        // ä¿å­˜è´¦æˆ·é…ç½®ï¼ˆåªåœ¨å¯†ç å˜æ›´æ—¶è°ƒç”¨ï¼‰
        function saveAccountConfig(username, password) {
            if (password === '***') {
                return; // ä¸ä¿å­˜ç‰¹æ®Šæ ‡è®°
            }

            fetch('/api/config/campus_account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('è´¦æˆ·é…ç½®ä¿å­˜æˆåŠŸ');
                    } else {
                        console.error('è´¦æˆ·é…ç½®ä¿å­˜å¤±è´¥:', data.message);
                    }
                })
                .catch(error => console.error('ä¿å­˜è´¦æˆ·é…ç½®å¤±è´¥:', error));
        }

        // æ¸…é™¤ä¿å­˜çš„å¯†ç 
        function clearSavedPassword() {
            const passwordField = document.getElementById('autoPassword');
            passwordField.removeAttribute('data-has-saved-password');
            passwordField.placeholder = 'è¯·è¾“å…¥ç»Ÿä¸€èº«ä»½è®¤è¯å¯†ç ';
            passwordField.value = '';

            // ç§»é™¤æç¤º
            const hint = passwordField.parentElement.querySelector('.password-saved-hint');
            if (hint) {
                hint.remove();
            }

            // æ¸…é™¤æœåŠ¡å™¨ç«¯ä¿å­˜çš„å¯†ç 
            const username = document.getElementById('autoUsername').value.trim();
            if (username) {
                saveAccountConfig(username, ''); // ä¿å­˜ç©ºå¯†ç 
            }
        }

        function showAutoGetResult(message, type) {
            const resultDiv = document.getElementById('autoGetResult');
            const alertDiv = document.getElementById('autoGetAlert');
            const messageDiv = document.getElementById('autoGetMessage');

            messageDiv.innerHTML = message;
            alertDiv.className = `alert alert-${type}`;
            resultDiv.style.display = 'block';
        }

        function showManualResult(message, type) {
            const resultDiv = document.getElementById('manualResult');
            const alertDiv = document.getElementById('manualAlert');
            const messageDiv = document.getElementById('manualMessage');

            messageDiv.innerHTML = message;
            alertDiv.className = `alert alert-${type}`;
            resultDiv.style.display = 'block';
        }
    </script>
</body>

</html>