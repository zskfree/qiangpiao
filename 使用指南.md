# 深圳大学体育场馆抢票系统 - 完整使用指南

## 🎯 系统完善情况

✅ **已实现的功能:**

1. **Web界面操作** - 友好的网页界面，支持可视化配置和监控
2. **SSL握手优化** - 自定义SSL适配器，完美解决连接问题
3. **完善异常处理** - 网络超时、SSL错误、JSON解析等全面覆盖
4. **智能重试机制** - 可配置重试次数和间隔，支持中断控制
5. **实时状态检查** - 自动检测Cookie有效性和登录状态
6. **优先级预约策略** - 按时段优先级智能选择最佳场地
7. **详细日志系统** - 文件和控制台双重日志记录
8. **多时间段预约** - 支持最多2个不同时间段同时预约
9. **Cookie管理系统** - 自动化Cookie更新、验证和备份
10. **进程生命周期管理** - 优雅启动和停止，自动清理历史状态
11. **实时Web监控** - 网页实时显示抢票进度和结果
12. **状态持久化** - 每次启动自动重置，确保干净状态

## 📁 完整文件结构

```
d:\projects\qiangpiao\
├── 核心文件
│   ├── qiangpiao.py        # 主抢票逻辑
│   ├── config.py           # 配置文件
│   ├── web_app.py          # Flask Web应用
│   ├── start_web.py        # Web服务启动脚本
│   └── cookie_manager.py   # Cookie管理工具
├── 启动文件
│   └── start.bat           # Windows一键启动
├── Web模板
│   └── templates/
│       ├── base.html       # 基础模板
│       ├── index.html      # 主页
│       ├── config.html     # 配置页面
│       ├── cookie.html     # Cookie管理页面
│       └── booking.html    # 抢票监控页面
├── 静态资源
│   └── static/             # CSS/JS资源（自动创建）
├── 文档
│   └── 使用指南.md         # 本文档
└── 运行时文件
    ├── qiangpiao.log       # 运行日志
    ├── cookie_backup_*.txt # Cookie备份
    └── __pycache__/        # Python缓存（自动清理）
```

## 🚀 三种使用方式

### 方式一：Web界面（推荐）

1. **一键启动**

   ```bash
   # Windows用户
   双击 start.bat
   
   # 或命令行启动
   python start_web.py
   ```

2. **访问Web界面**
   - 浏览器自动打开：<http://localhost:5000>
   - 或手动访问：<http://localhost:5000>

3. **Web界面功能**
   - 📊 **首页Dashboard**: 系统状态总览
   - ⚙️ **配置管理**: 可视化修改所有参数
   - 🔑 **Cookie管理**: 测试、更新、查看当前Cookie
   - 🎯 **抢票监控**: 实时查看抢票进度和结果

### 方式二：命令行工具

```bash
# 普通模式
python qiangpiao.py

# 调试模式
python qiangpiao.py --debug

# Cookie管理
python cookie_manager.py check
python cookie_manager.py update
```

### 方式三：批处理启动

```bash
# Windows一键启动（推荐）
start.bat
```

## ⚙️ 详细配置指南

### 1. 基础配置 (config.py)

```python
CONFIG = {
    # 校区和项目
    "XQ": "1",              # 1=粤海校区, 2=丽湖校区
    "XMDM": "001",          # 001=羽毛球
    
    # 预约设置
    "TARGET_DATE": "2025-05-26",        # 目标日期
    "PREFERRED_TIMES": [                # 优先时段（按优先级排序）
        "12:00-13:00",                  # 最高优先级
        "13:00-14:00"                   # 次高优先级
    ],
    
    # 用户信息（必须修改！）
    "USER_INFO": {
        "YYRGH": "你的学号",            # 真实学号
        "YYRXM": "你的姓名"             # 真实姓名
    },
    
    # 运行参数
    "MAX_RETRY_TIMES": 200,            # 最大重试次数
    "RETRY_INTERVAL": 1,               # 重试间隔（秒）
    "REQUEST_TIMEOUT": 10              # 请求超时（秒）
}
```

### 2. Web界面配置

通过Web界面 → 配置页面，可以实时修改：

- 校区选择（粤海/丽湖）
- 目标预约日期
- 优先时间段列表
- 用户信息（学号/姓名）
- 运行参数（重试次数/间隔）

### 3. Cookie管理

#### Web界面管理（推荐）

1. 进入 Cookie管理页面
2. 查看当前Cookie状态
3. 测试Cookie有效性
4. 更新Cookie（支持一键复制）

#### 命令行管理

```bash
# 检查状态
python cookie_manager.py check

# 交互式更新
python cookie_manager.py update
```

#### 获取Cookie步骤

1. 浏览器登录 <https://ehall.szu.edu.cn>
2. 进入体育场馆预约系统
3. F12开发者工具 → Network标签
4. 刷新页面，点击任意请求
5. Request Headers中找到Cookie
6. 复制完整Cookie值
7. 粘贴到Web界面或命令行

## 🎯 抢票策略详解

### 智能预约逻辑

1. **多时段并行监控**
   - 同时监控所有配置的优先时段
   - 按优先级顺序尝试预约

2. **场地智能选择**
   - 自动选择每个时段的最优场地
   - 避重复预约相同时段

3. **限制自动检测**
   - 最多预约2个不同时间段
   - 达到上限自动停止

4. **异常智能处理**
   - 网络异常自动重试
   - Cookie失效提示更新
   - 预约冲突智能跳过

### 最佳使用策略

1. **时机选择**
   - 预约开放前2-3分钟启动
   - 网络环境稳定时段

2. **配置优化**
   - 重试间隔设为1-2秒
   - 配置3-5个候选时段
   - 保持Cookie最新状态

3. **监控要点**
   - Web界面实时查看状态
   - 关注预约成功提示
   - 监控系统异常信息

## 🔧 故障排除指南

### 常见问题及解决方案

#### 1. Web服务启动失败

**症状**: 双击start.bat无反应或报错
**解决**:

```bash
# 检查Python环境
python --version

# 检查Flask安装
pip install flask

# 手动启动
python start_web.py
```

#### 2. Cookie相关问题

**症状**: 提示"Cookie已失效"
**解决**:

- Web界面 → Cookie管理 → 重新检查
- 或命令行: `python cookie_manager.py update`

#### 3. 端口被占用

**症状**: "Address already in use"
**解决**:

- 关闭其他使用5000端口的程序
- 或等待几秒后重试

#### 4. 抢票无结果

**症状**: 长时间运行无预约成功
**检查**:

- 目标日期是否正确
- 时间段是否已开放预约
- Cookie是否有效
- 网络连接是否稳定

#### 5. 预约记录重复显示

**解决**: 重启Web服务会自动清理历史记录

### 调试技巧

1. **启用调试模式**

   ```bash
   python qiangpiao.py --debug
   ```

2. **查看详细日志**

   ```bash
   # 实时查看日志
   tail -f qiangpiao.log    # Linux/Mac
   type qiangpiao.log       # Windows
   ```

3. **Web界面调试**
   - 抢票页面实时显示状态
   - Cookie页面检查连接状态
   - 配置页面验证参数设置

## 📊 系统特性总览

### 🌐 Web界面特性

- **响应式设计**: 支持桌面和移动端
- **实时更新**: 抢票状态实时刷新
- **可视化配置**: 所有参数可视化修改
- **状态监控**: Cookie状态和系统状态实时显示
- **历史清理**: 每次启动自动重置状态

### 🤖 智能化特性

- **自动重试**: 网络异常自动恢复
- **优先级预约**: 智能选择最佳时段
- **状态检测**: 实时检测登录和Cookie状态
- **异常处理**: 全面的错误处理和用户提示
- **资源管理**: 自动清理日志和缓存文件

### 🛡️ 稳定性特性

- **SSL优化**: 完美解决SSL握手问题
- **超时控制**: 防止请求挂起
- **进程管理**: 优雅启动和停止
- **内存管理**: 自动清理Python缓存
- **并发安全**: 线程安全的状态管理

## 🎉 成功案例展示

### Web界面运行效果

```
🚀 正在启动深圳大学体育场馆抢票系统...
🧹 清理历史文件...
🔄 重置模块状态...
📁 检查必要文件...
📡 启动Web服务器...
🌐 服务地址: http://localhost:5000
💡 按 Ctrl+C 可停止服务
--------------------------------------------------
📦 导入Web应用模块...
✨ 初始化应用状态...
🌐 Web服务器启动成功！
🌐 浏览器已打开
```

### 抢票成功界面

Web界面实时显示：

- ✅ Cookie状态: 有效
- 📅 目标日期: 2025-05-26
- 🎯 运行状态: 抢票进行中
- 📊 查询次数: 第15次
- ⏱️ 运行时间: 00:02:30
- 🎉 预约成功: 12:00-13:00 - 至快体育馆A1

## ⚠️ 重要提醒

### 必须配置项

1. **用户信息**: 必须修改为真实学号和姓名
2. **Cookie更新**: 定期更新保持有效性
3. **目标日期**: 设置为有效的预约日期

### 使用规范

1. **合规使用**: 遵守学校相关规定
2. **适度频率**: 不要设置过短重试间隔
3. **隐私保护**: 妥善保管Cookie信息
4. **单次运行**: 避免同时运行多个实例

### 技术限制

1. **预约上限**: 每日最多2个不同时间段
2. **系统依赖**: 需要稳定的网络环境
3. **浏览器限制**: Cookie有时效性
4. **服务器限制**: 遵循学校服务器访问规则

## 🆘 获取帮助

### 自助诊断

1. **Web界面**: Cookie管理页面 → 重新检查
2. **命令行**: `python cookie_manager.py check`
3. **调试模式**: `python qiangpiao.py --debug`
4. **日志分析**: 查看 `qiangpiao.log` 文件

### 常用命令速查

```bash
# 启动Web界面
python start_web.py

# 检查Cookie
python cookie_manager.py check

# 更新Cookie
python cookie_manager.py update

# 命令行抢票
python qiangpiao.py

# 调试模式
python qiangpiao.py --debug
```

---

🎊 **祝您抢票成功！** 这个完善的Web版抢票系统将为您提供最佳的预约体验！🏸
