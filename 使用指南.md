# 深圳大学体育场馆抢票脚本 - 完整使用指南

## 🎯 脚本完善情况

✅ **已解决的问题:**

1. **SSL握手失败** - 添加了自定义SSL适配器和安全级别调整
2. **完善的异常处理** - 包含网络超时、SSL错误、JSON解析错误等
3. **智能重试机制** - 可配置的重试次数和间隔
4. **登录状态检查** - 自动检测Cookie是否有效
5. **优先级预约** - 按配置的时段优先级自动选择
6. **详细日志记录** - 文件和控制台双重输出
7. **用户友好界面** - 美观的输出和实时统计
8. **多时间段预约** - 最多同时预约2个不同时间段
9. **Cookie管理工具** - 自动化Cookie更新和验证
10. **调试模式** - 详细的调试信息输出

## 📁 文件结构

```
d:\projects\qiangpiao\
├── qiangpiao.py        # 主程序脚本
├── config.py           # 配置文件
├── cookie_manager.py   # Cookie管理工具
├── utils.py            # 辅助工具（可选）
├── test_network.py     # 网络连接测试（可选）
├── test_init.py        # 初始化测试（可选）
├── start.bat           # Windows启动脚本（可选）
├── 使用指南.md         # 本文档
└── qiangpiao.log       # 运行日志（运行后生成）
```

## 🚀 快速开始

### 1. 配置用户信息（重要！）

编辑 `config.py` 文件，修改以下信息：

```python
"USER_INFO": {
    "YYRGH": "你的学号",    # 必须修改为真实学号
    "YYRXM": "你的姓名"     # 必须修改为真实姓名
}
```

### 2. 更新Cookie（重要！）

```bash
# 检查当前Cookie状态
python cookie_manager.py check

# 更新Cookie（推荐）
python cookie_manager.py update
```

### 3. 配置预约参数

编辑 `config.py` 中的关键配置：

```python
CONFIG = {
    "XQ": "1",                    # 校区：1=粤海, 2=丽湖
    "XMDM": "001",               # 项目：001=羽毛球
    "TARGET_DATE": "2025-05-26", # 目标日期
    "PREFERRED_TIMES": [         # 优先时段
        "12:00-13:00",
        "13:00-14:00"
    ]
}
```

### 4. 运行抢票脚本

```bash
# 普通模式
python qiangpiao.py

# 调试模式（显示详细信息）
python qiangpiao.py --debug
```

## ⚙️ 详细配置说明

### 基础配置

- `XQ`: 校区选择
  - `"1"` = 粤海校区
  - `"2"` = 丽湖校区
- `XMDM`: 运动项目
  - `"001"` = 羽毛球
  - `"002"` = 乒乓球（如支持）
- `TARGET_DATE`: 预约目标日期，格式："YYYY-MM-DD"

### 时间段配置

```python
"PREFERRED_TIMES": [
    "12:00-13:00",  # 最高优先级
    "13:00-14:00",  # 次高优先级
    "19:00-20:00",  # 备选1
    "20:00-21:00",  # 备选2
]
```

### 用户信息配置

```python
"USER_INFO": {
    "YYRGH": "你的学号",  # 必须是真实学号
    "YYRXM": "你的姓名"   # 必须是真实姓名
}
```

## 🔧 Cookie管理工具

### 检查Cookie状态

```bash
python cookie_manager.py check
```

### 更新Cookie步骤

1. 运行更新命令：

   ```bash
   python cookie_manager.py update
   ```

2. 按提示获取新Cookie：
   - 浏览器登录体育场馆预约系统
   - F12开发者工具 → Network标签
   - 刷新页面，找到任意请求
   - 复制Request Headers中的Cookie值
   - 粘贴到终端中

3. 工具会自动验证Cookie有效性并更新文件

## 💡 使用技巧

### 1. 最佳运行时机

- 预约开放前2-3分钟启动脚本
- 通常在前一天的固定时间点开放预约

### 2. 提高成功率

- 网络环境稳定
- Cookie保持最新
- 合理设置重试间隔（推荐2-3秒）
- 使用调试模式排查问题

### 3. 多时间段策略

- 脚本最多预约2个不同时间段
- 按优先级自动选择最佳时段
- 已预约的时段会自动跳过

### 4. 调试技巧

```bash
# 启用调试模式
python qiangpiao.py --debug

# 查看运行日志
cat qiangpiao.log  # Linux/Mac
type qiangpiao.log # Windows
```

## 🔧 故障排除

### 问题1: Cookie失效

```bash
# 解决方案
python cookie_manager.py update
```

### 问题2: 登录状态异常

**症状**: 提示"登录状态失效"
**解决**:

1. 检查网络连接
2. 更新Cookie
3. 确认账号未被限制

### 问题3: SSL连接错误

**症状**: SSL握手失败
**解决**: ✅ 已自动解决（脚本已优化SSL配置）

### 问题4: 预约失败

**常见原因**:

- 时间段已被预约
- 已达到预约上限（每日最多2次）
- 目标日期设置错误

### 问题5: 找不到可用时段

**检查项**:

1. 目标日期是否正确
2. 时间段配置是否匹配
3. 是否在预约开放时间

## 📊 脚本特性

- ⚡ **高效率**: 最小2秒查询间隔，避免过于频繁请求
- 🛡️ **稳定性**: 完善的异常处理和自动重试
- 🎯 **智能化**: 多时间段优先级预约
- 📝 **可追踪**: 详细的日志记录和实时状态
- 🔄 **可配置**: 灵活的参数设置
- 👥 **用户友好**: 清晰的界面和操作提示
- 🔧 **自动化**: Cookie管理和状态检查
- 🐛 **可调试**: 详细的调试信息输出

## ⚠️ 注意事项

1. **用户信息**: 必须配置真实的学号和姓名
2. **预约限制**: 每日最多预约2个不同时间段
3. **时间设置**: 建议目标日期设为明天或更晚
4. **合规使用**: 请遵守学校相关规定
5. **隐私保护**: Cookie信息请妥善保管
6. **服务器负载**: 合理设置重试间隔

## 🎉 运行示例

### 启动界面

```
============================================================
🎾 深圳大学体育场馆抢票脚本 v3.3
============================================================
📅 目标日期: 2025-05-26
🏫 校区: 粤海
🏸 项目: 羽毛球
👤 预约人: 张三 (2023123456)
⏱️  重试间隔: 2秒
🔄 最大重试: 200次
🎯 预约目标: 最多2个不同时间段
============================================================
```

### 查询过程

```
[14:30:15] 📡 第 1 次查询... (已预约: 0/2)
📭 暂无可预约时段
⏳ 等待 2 秒后重试...

[14:30:18] 📡 第 2 次查询... (已预约: 0/2)
🎉 找到 3 个可预约时段!
🔍 过滤后剩余 3 个新时段可预约:
   1. 12:00-13:00 (2个场地可选) - 优先级: 0
   2. 13:00-14:00 (1个场地可选) - 优先级: 1
   3. 19:00-20:00 (3个场地可选) - 优先级: 2
```

### 预约成功

```
🎯 尝试预约时间段 12:00-13:00:
   选择场地: 至快体育馆羽毛球场A1 (共2个可选)
✅ 预约成功！场地：12:00-13:00 - 至快体育馆羽毛球场A1
🎉 预约成功！当前已预约 1/2 个时间段

🎯 尝试预约时间段 13:00-14:00:
   选择场地: 至快体育馆羽毛球场B2 (共1个可选)
✅ 预约成功！场地：13:00-14:00 - 至快体育馆羽毛球场B2

🎊 太棒了！已成功预约满 2 个时间段！

📋 最终预约详情:
   1. 12:00-13:00 - 至快体育馆羽毛球场A1
   2. 13:00-14:00 - 至快体育馆羽毛球场B2
```

## 🆘 获取帮助

1. **Cookie问题**: 运行 `python cookie_manager.py check`
2. **配置问题**: 检查 `config.py` 中的设置
3. **调试信息**: 使用 `python qiangpiao.py --debug`
4. **日志分析**: 查看 `qiangpiao.log` 文件

希望这个完善的抢票脚本能帮助你成功预约到心仪的运动时段！🏸
